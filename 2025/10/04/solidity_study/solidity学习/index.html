<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" integrity="sha256-AbA177XfpSnFEvgpYu1jMygiLabzPCJCRIBtR5jGc0k=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.13.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"æœç´¢...","empty":"æ²¡æœ‰æ‰¾åˆ°ä»»ä½•æœç´¢ç»“æœï¼š${query}","hits_time":"æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœï¼ˆç”¨æ—¶ ${time} æ¯«ç§’ï¼‰","hits":"æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœ"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="è¿™æ˜¯æ–‡ç« å¼€å¤´ï¼Œæ˜¾ç¤ºåœ¨ä¸»é¡µé¢ï¼Œè¯¦æƒ…è¯·ç‚¹å‡»æ­¤å¤„ã€‚">
<meta property="og:type" content="article">
<meta property="og:title" content="solidityå­¦ä¹ ">
<meta property="og:url" content="http://example.com/2025/10/04/solidity_study/solidity%E5%AD%A6%E4%B9%A0/index.html">
<meta property="og:site_name" content="Tiger_pop&#39;s Blog">
<meta property="og:description" content="è¿™æ˜¯æ–‡ç« å¼€å¤´ï¼Œæ˜¾ç¤ºåœ¨ä¸»é¡µé¢ï¼Œè¯¦æƒ…è¯·ç‚¹å‡»æ­¤å¤„ã€‚">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2025-10-04T02:27:21.000Z">
<meta property="article:modified_time" content="2025-10-16T10:08:35.252Z">
<meta property="article:author" content="é™ˆå®‡éŸ¶chenyushao">
<meta property="article:tag" content="solidity">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://example.com/2025/10/04/solidity_study/solidity%E5%AD%A6%E4%B9%A0/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"http://example.com/2025/10/04/solidity_study/solidity%E5%AD%A6%E4%B9%A0/","path":"2025/10/04/solidity_study/solidityå­¦ä¹ /","title":"solidityå­¦ä¹ "}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>solidityå­¦ä¹  | Tiger_pop's Blog</title>
  






  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="Tiger_pop's Blog" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ " role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Tiger_pop's Blog</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">tiger_pop çš„åšå®¢</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>é¦–é¡µ</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>å…³äº</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>æ ‡ç­¾</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>åˆ†ç±»</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>å½’æ¡£</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%87%A0%E4%B8%AA%E5%AE%9E%E4%BE%8B"><span class="nav-number">1.</span> <span class="nav-text">å‡ ä¸ªå®ä¾‹</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%80%89%E4%B8%BE"><span class="nav-number">1.1.</span> <span class="nav-text">é€‰ä¸¾</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%99%AE%E9%80%9A%E7%AB%9E%E6%8B%8D"><span class="nav-number">1.2.</span> <span class="nav-text">æ™®é€šç«æ‹</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E2%80%9D%E6%A3%80%E6%9F%A5-%E7%94%9F%E6%95%88-%E4%BA%A4%E4%BA%92%E2%80%9D-%E5%8E%9F%E5%88%99"><span class="nav-number">1.3.</span> <span class="nav-text">**â€æ£€æŸ¥-ç”Ÿæ•ˆ-äº¤äº’â€**åŸåˆ™</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%9B%B2%E6%8B%8D"><span class="nav-number">1.4.</span> <span class="nav-text">ç›²æ‹</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BF%9C%E7%A8%8B%E8%B4%AD%E4%B9%B0"><span class="nav-number">1.5.</span> <span class="nav-text">è¿œç¨‹è´­ä¹°</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BE%AE%E6%94%AF%E4%BB%98%E9%80%9A%E9%81%93"><span class="nav-number">1.6.</span> <span class="nav-text">å¾®æ”¯ä»˜é€šé“</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%88%E4%B8%80%EF%BC%89%E9%80%9A%E4%BF%97%E7%9A%84%E4%BE%8B%E5%AD%90%EF%BC%88%E6%96%B0%E4%BA%BA%E5%BF%85%E7%9C%8B%EF%BC%89"><span class="nav-number">1.6.1.</span> <span class="nav-text">ï¼ˆä¸€ï¼‰é€šä¿—çš„ä¾‹å­ï¼ˆæ–°äººå¿…çœ‹ï¼‰</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%F0%9F%AA%99-%E7%AC%AC%E4%B8%80%E6%AD%A5%EF%BC%9A%E5%BC%80%E9%80%9A%E9%80%9A%E9%81%93%EF%BC%88%E4%B8%8A%E9%93%BE%EF%BC%89"><span class="nav-number">1.6.1.1.</span> <span class="nav-text">ğŸª™ ç¬¬ä¸€æ­¥ï¼šå¼€é€šé€šé“ï¼ˆä¸Šé“¾ï¼‰</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E2%9C%8D%EF%B8%8F-%E7%AC%AC%E4%BA%8C%E6%AD%A5%EF%BC%9A%E7%A6%BB%E7%BA%BF%E7%AD%BE%E5%90%8D%EF%BC%88%E7%A6%BB%E9%93%BE%E6%94%AF%E4%BB%98%EF%BC%89"><span class="nav-number">1.6.1.2.</span> <span class="nav-text">âœï¸ ç¬¬äºŒæ­¥ï¼šç¦»çº¿ç­¾åï¼ˆç¦»é“¾æ”¯ä»˜ï¼‰</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%F0%9F%94%90-%E2%80%9C%E7%AD%BE%E7%BD%B2%E5%86%85%E5%AE%B9%E2%80%9D%E5%88%B0%E5%BA%95%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F"><span class="nav-number">1.6.1.3.</span> <span class="nav-text">ğŸ” â€œç­¾ç½²å†…å®¹â€åˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿ</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%F0%9F%92%A1-%E7%AC%AC%E4%B8%89%E6%AD%A5%EF%BC%9A%E9%80%9A%E9%81%93%E7%BB%93%E7%AE%97%EF%BC%88%E4%B8%8A%E9%93%BE%E4%B8%80%E6%AC%A1%EF%BC%89"><span class="nav-number">1.6.1.4.</span> <span class="nav-text">ğŸ’¡ ç¬¬ä¸‰æ­¥ï¼šé€šé“ç»“ç®—ï¼ˆä¸Šé“¾ä¸€æ¬¡ï¼‰</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%88%E4%BA%8C%EF%BC%89%E5%AE%98%E7%BD%91%E7%9A%84%E4%BE%8B%E5%AD%90"><span class="nav-number">1.6.2.</span> <span class="nav-text">ï¼ˆäºŒï¼‰å®˜ç½‘çš„ä¾‹å­</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E7%AD%BE%E5%90%8D"><span class="nav-number">1.6.2.1.</span> <span class="nav-text">åˆ›å»ºç­¾å</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AD%BE%E7%BD%B2%E5%86%85%E5%AE%B9"><span class="nav-number">1.6.2.2.</span> <span class="nav-text">ç­¾ç½²å†…å®¹</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BB%84%E8%A3%85%E5%8F%82%E6%95%B0"><span class="nav-number">1.6.2.3.</span> <span class="nav-text">ç»„è£…å‚æ•°</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9C%A8Solidity%E4%B8%AD%E6%81%A2%E5%A4%8D%E4%BF%A1%E6%81%AF%E7%AD%BE%E5%90%8D%E8%80%85"><span class="nav-number">1.6.2.4.</span> <span class="nav-text">åœ¨Solidityä¸­æ¢å¤ä¿¡æ¯ç­¾åè€…</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BB%A3%E7%A0%81"><span class="nav-number">1.6.2.5.</span> <span class="nav-text">ä»£ç </span></a></li></ol></li></ol></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="é™ˆå®‡éŸ¶chenyushao"
      src="/images/my.jpg">
  <p class="site-author-name" itemprop="name">é™ˆå®‡éŸ¶chenyushao</p>
  <div class="site-description" itemprop="description">çˆ±å­¦ä¹ ã€çˆ±å·¥ä½œã€çˆ±ç”Ÿæ´»;         å¾®ä¿¡å·: Tiger_and_master;         æ‰‹æœºå·ç :18515678348 </div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">430</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">26</span>
        <span class="site-state-item-name">åˆ†ç±»</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">209</span>
        <span class="site-state-item-name">æ ‡ç­¾</span></a>
      </div>
  </nav>
</div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="è¿”å›é¡¶éƒ¨">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/10/04/solidity_study/solidity%E5%AD%A6%E4%B9%A0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/my.jpg">
      <meta itemprop="name" content="é™ˆå®‡éŸ¶chenyushao">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Tiger_pop's Blog">
      <meta itemprop="description" content="çˆ±å­¦ä¹ ã€çˆ±å·¥ä½œã€çˆ±ç”Ÿæ´»;         å¾®ä¿¡å·: Tiger_and_master;         æ‰‹æœºå·ç :18515678348 ">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="solidityå­¦ä¹  | Tiger_pop's Blog">
      <meta itemprop="description" content="è¿™æ˜¯æ–‡ç« å¼€å¤´ï¼Œæ˜¾ç¤ºåœ¨ä¸»é¡µé¢ï¼Œè¯¦æƒ…è¯·ç‚¹å‡»æ­¤å¤„ã€‚">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          solidityå­¦ä¹ 
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2025-10-04 10:27:21" itemprop="dateCreated datePublished" datetime="2025-10-04T10:27:21+08:00">2025-10-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">æ›´æ–°äº</span>
      <time title="ä¿®æ”¹æ—¶é—´ï¼š2025-10-16 18:08:35" itemprop="dateModified" datetime="2025-10-16T18:08:35+08:00">2025-10-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%8C%BA%E5%9D%97%E9%93%BE/" itemprop="url" rel="index"><span itemprop="name">åŒºå—é“¾</span></a>
        </span>
    </span>

  
</div>

            <div class="post-description">è¿™æ˜¯æ–‡ç« å¼€å¤´ï¼Œæ˜¾ç¤ºåœ¨ä¸»é¡µé¢ï¼Œè¯¦æƒ…è¯·ç‚¹å‡»æ­¤å¤„ã€‚</div>
        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p>solidityæ–‡æ¡£ <code>https://learnblockchain.cn/docs/solidity/</code></p>
<h1 id="å‡ ä¸ªå®ä¾‹"><a href="#å‡ ä¸ªå®ä¾‹" class="headerlink" title="å‡ ä¸ªå®ä¾‹"></a>å‡ ä¸ªå®ä¾‹</h1><h2 id="é€‰ä¸¾"><a href="#é€‰ä¸¾" class="headerlink" title="é€‰ä¸¾"></a>é€‰ä¸¾</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: GPL-3.0</span><br><span class="line">pragma solidity &gt;=0.7.0 &lt;0.9.0;</span><br><span class="line">/// @title å§”æ‰˜æŠ•ç¥¨</span><br><span class="line">contract Ballot &#123;</span><br><span class="line">    // è¿™é‡Œå£°æ˜äº†ä¸€ä¸ªæ–°çš„å¤åˆç±»å‹ç”¨äºç¨åçš„å˜é‡ã€‚</span><br><span class="line">    // è¯¥å˜é‡ç”¨æ¥è¡¨ç¤ºä¸€ä¸ªé€‰æ°‘ã€‚</span><br><span class="line">    struct Voter &#123;</span><br><span class="line">        uint weight; // è®¡ç¥¨çš„æƒé‡</span><br><span class="line">        bool voted;  // è‹¥ä¸ºçœŸï¼Œä»£è¡¨è¯¥äººå·²æŠ•ç¥¨</span><br><span class="line">        address delegate; // è¢«å§”æ‰˜äºº</span><br><span class="line">        uint vote;   // æŠ•ç¥¨ææ¡ˆçš„ç´¢å¼•</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // ææ¡ˆçš„ç±»å‹.</span><br><span class="line">    struct Proposal &#123;</span><br><span class="line">        bytes32 name;   // ç®€ç§°ï¼ˆæœ€é•¿32ä¸ªå­—èŠ‚ï¼‰</span><br><span class="line">        uint voteCount; // å¾—ç¥¨æ•°  </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    address public chairperson;</span><br><span class="line"></span><br><span class="line">    // è¿™å£°æ˜äº†ä¸€ä¸ªçŠ¶æ€å˜é‡ï¼Œä¸ºæ¯ä¸ªå¯èƒ½çš„åœ°å€å­˜å‚¨ä¸€ä¸ª `Voter`ã€‚</span><br><span class="line">    mapping(address =&gt; Voter) public voters;</span><br><span class="line"></span><br><span class="line">    // ä¸€ä¸ª `Proposal` ç»“æ„ç±»å‹çš„åŠ¨æ€æ•°ç»„</span><br><span class="line">    Proposal[] public proposals;</span><br><span class="line"></span><br><span class="line">    /// ä¸º `proposalNames` ä¸­çš„æ¯ä¸ªææ¡ˆï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„ï¼ˆæŠ•ç¥¨ï¼‰è¡¨å†³ memory è¡¨ç¤º ä»ä¸´æ—¶å†…å­˜ä¸­è¯»å–ï¼Œå°±æ˜¯ è·å–å¤–éƒ¨è¾“å…¥ã€‚ </span><br><span class="line">    constructor(bytes32[] memory proposalNames) &#123;  // è¿™é‡Œç”¨ memory ä¸´æ—¶ç”¨ä¸€ä¸‹ï¼Œä½†æ˜¯proposals.push ä¼šè®©å†…å®¹ä¿å­˜åˆ°æ°¸ä¹… storageä¸­ã€‚ </span><br><span class="line">        chairperson = msg.sender;                  // msg.sender æ˜¯è°ƒç”¨åˆçº¦è€…ï¼ˆæ¶ˆæ¯å‘é€è€…ï¼‰è‡ªå·±çš„åœ°å€ã€‚</span><br><span class="line">        voters[chairperson].weight = 1;</span><br><span class="line"></span><br><span class="line">        //å¯¹äºæä¾›çš„æ¯ä¸ªææ¡ˆåç§°ï¼Œ</span><br><span class="line">        //åˆ›å»ºä¸€ä¸ªæ–°çš„ Proposal å¯¹è±¡å¹¶æŠŠå®ƒæ·»åŠ åˆ°æ•°ç»„çš„æœ«å°¾ã€‚</span><br><span class="line">        for (uint i = 0; i &lt; proposalNames.length; i++) &#123;</span><br><span class="line">            // `Proposal(&#123;...&#125;)` åˆ›å»ºä¸€ä¸ªä¸´æ—¶ Proposal å¯¹è±¡ï¼Œ</span><br><span class="line">            // `proposals.push(...)` å°†å…¶æ·»åŠ åˆ° `proposals` çš„æœ«å°¾</span><br><span class="line">            proposals.push(Proposal(&#123;</span><br><span class="line">                name: proposalNames[i],</span><br><span class="line">                voteCount: 0</span><br><span class="line">            &#125;));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // æˆæƒ `voter` å¯¹è¿™ä¸ªï¼ˆæŠ•ç¥¨ï¼‰è¡¨å†³è¿›è¡ŒæŠ•ç¥¨ã€‚</span><br><span class="line">    // åªæœ‰ `chairperson` å¯ä»¥è°ƒç”¨è¯¥å‡½æ•°ã€‚</span><br><span class="line">    function giveRightToVote(address voter) external &#123;</span><br><span class="line">        // è‹¥ `require` çš„ç¬¬ä¸€ä¸ªå‚æ•°çš„è®¡ç®—ç»“æœä¸º `false`ï¼Œ</span><br><span class="line">        // åˆ™ç»ˆæ­¢æ‰§è¡Œï¼Œæ’¤é”€æ‰€æœ‰å¯¹çŠ¶æ€å’Œä»¥å¤ªå¸ä½™é¢çš„æ”¹åŠ¨ã€‚</span><br><span class="line">        // åœ¨æ—§ç‰ˆçš„ EVM ä¸­è¿™æ›¾ç»ä¼šæ¶ˆè€—æ‰€æœ‰ gasï¼Œä½†ç°åœ¨ä¸ä¼šäº†ã€‚</span><br><span class="line">        // ä½¿ç”¨ require æ¥æ£€æŸ¥å‡½æ•°æ˜¯å¦è¢«æ­£ç¡®åœ°è°ƒç”¨ï¼Œæ˜¯ä¸€ä¸ªå¥½ä¹ æƒ¯ã€‚</span><br><span class="line">        // ä½ ä¹Ÿå¯ä»¥åœ¨ require çš„ç¬¬äºŒä¸ªå‚æ•°ä¸­æä¾›ä¸€ä¸ªå¯¹é”™è¯¯æƒ…å†µçš„è§£é‡Šã€‚</span><br><span class="line">        require(</span><br><span class="line">            msg.sender == chairperson,</span><br><span class="line">            &quot;Only chairperson can give right to vote.&quot;</span><br><span class="line">        );</span><br><span class="line">        require(</span><br><span class="line">            !voters[voter].voted,</span><br><span class="line">            &quot;The voter already voted.&quot;</span><br><span class="line">        );</span><br><span class="line">        require(voters[voter].weight == 0);  // é¿å… é‡å¤æˆæƒ ï¼Œè¿™æ ·æ— æ„ä¹‰ã€‚ </span><br><span class="line">        voters[voter].weight = 1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /// æŠŠä½ çš„æŠ•ç¥¨å§”æ‰˜åˆ°æŠ•ç¥¨è€… `to`ã€‚</span><br><span class="line">    function delegate(address to) external &#123;</span><br><span class="line">        // ä¼ å¼•ç”¨</span><br><span class="line">        Voter storage sender = voters[msg.sender];  //storage â†’ &quot;ä¿®æ”¹æ°¸ä¹…çŠ¶æ€&quot;åç»­æ“ä½œç›´æ¥ä¿®æ”¹åŒºå—é“¾çŠ¶æ€ï¼›memory â†’ &quot;æˆ‘åªéœ€è¦ä¸´æ—¶è®¡ç®—&quot;</span><br><span class="line">        require(sender.weight != 0, &quot;You have no right to vote&quot;);</span><br><span class="line">        require(!sender.voted, &quot;You already voted.&quot;);</span><br><span class="line"></span><br><span class="line">        require(to != msg.sender, &quot;Self-delegation is disallowed.&quot;);</span><br><span class="line"></span><br><span class="line">        // å§”æ‰˜æ˜¯å¯ä»¥ä¼ é€’çš„ï¼Œåªè¦è¢«å§”æ‰˜è€… `to` ä¹Ÿè®¾ç½®äº†å§”æ‰˜ã€‚</span><br><span class="line">        // ä¸€èˆ¬æ¥è¯´ï¼Œè¿™ç§å¾ªç¯å§”æ‰˜æ˜¯å±é™©çš„ã€‚å› ä¸ºï¼Œå¦‚æœä¼ é€’çš„é“¾æ¡å¤ªé•¿ï¼Œ</span><br><span class="line">        // åˆ™å¯èƒ½éœ€æ¶ˆè€—çš„gasè¦å¤šäºåŒºå—ä¸­å‰©ä½™çš„ï¼ˆå¤§äºåŒºå—è®¾ç½®çš„gasLimitï¼‰ï¼Œ</span><br><span class="line">        // è¿™ç§æƒ…å†µä¸‹ï¼Œå§”æ‰˜ä¸ä¼šè¢«æ‰§è¡Œã€‚</span><br><span class="line">        // è€Œåœ¨å¦ä¸€äº›æƒ…å†µä¸‹ï¼Œå¦‚æœå½¢æˆé—­ç¯ï¼Œåˆ™ä¼šè®©åˆçº¦å®Œå…¨å¡ä½ã€‚</span><br><span class="line">        while (voters[to].delegate != address(0)) &#123;  // æ‰¾åˆ° å§”æ‰˜é“¾çš„æœ€åä¸€ä¸ªå§”æ‰˜è€…ï¼Œaddress(0)æŒ‡çš„æ˜¯ nullç±»ä¼¼äºå§”æ‰˜é“¾çš„ç»ˆç‚¹ã€‚</span><br><span class="line">            to = voters[to].delegate;</span><br><span class="line"></span><br><span class="line">            // ä¸å…è®¸é—­ç¯å§”æ‰˜</span><br><span class="line">            require(to != msg.sender, &quot;Found loop in delegation.&quot;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Voter storage delegate_ = voters[to];      // æœ€ç»ˆå§”æ‰˜è€… ï¼ˆæœ€ç»ˆæŠ•ç¥¨è€…ï¼‰</span><br><span class="line"></span><br><span class="line">        // Voters cannot delegate to accounts that cannot vote.</span><br><span class="line">        require(delegate_.weight &gt;= 1);</span><br><span class="line"></span><br><span class="line">        // Since `sender` is a reference, this</span><br><span class="line">        // modifies `voters[msg.sender]`.</span><br><span class="line">        sender.voted = true;</span><br><span class="line">        sender.delegate = to;</span><br><span class="line"></span><br><span class="line">        if (delegate_.voted) &#123;</span><br><span class="line">            // è‹¥è¢«å§”æ‰˜è€…å·²ç»æŠ•è¿‡ç¥¨äº†ï¼Œç›´æ¥å¢åŠ å¾—ç¥¨æ•°</span><br><span class="line">            proposals[delegate_.vote].voteCount += sender.weight;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            // è‹¥è¢«å§”æ‰˜è€…è¿˜æ²¡æŠ•ç¥¨ï¼Œå¢åŠ å§”æ‰˜è€…çš„æƒé‡</span><br><span class="line">            delegate_.weight += sender.weight;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /// æŠŠä½ çš„ç¥¨(åŒ…æ‹¬å§”æ‰˜ç»™ä½ çš„ç¥¨)ï¼Œ</span><br><span class="line">    /// æŠ•ç»™ææ¡ˆ `proposals[proposal].name`.</span><br><span class="line">    function vote(uint proposal) external &#123;</span><br><span class="line">        Voter storage sender = voters[msg.sender];</span><br><span class="line">        require(sender.weight != 0, &quot;Has no right to vote&quot;);</span><br><span class="line">        require(!sender.voted, &quot;Already voted.&quot;);</span><br><span class="line">        sender.voted = true;</span><br><span class="line">        sender.vote = proposal;</span><br><span class="line"></span><br><span class="line">        // å¦‚æœ `proposal` è¶…è¿‡äº†æ•°ç»„çš„èŒƒå›´ï¼Œåˆ™ä¼šè‡ªåŠ¨æŠ›å‡ºå¼‚å¸¸ï¼Œå¹¶æ¢å¤æ‰€æœ‰çš„æ”¹åŠ¨</span><br><span class="line"></span><br><span class="line">        proposals[proposal].voteCount += sender.weight;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /// @dev ç»“åˆä¹‹å‰æ‰€æœ‰çš„æŠ•ç¥¨ï¼Œè®¡ç®—å‡ºæœ€ç»ˆèƒœå‡ºçš„ææ¡ˆ ï¼Œview åªè¯»ä¸ä¿®æ”¹çŠ¶æ€ï¼Œå…gasè´¹ã€‚</span><br><span class="line">    function winningProposal() public view  </span><br><span class="line">            returns (uint winningProposal_)    </span><br><span class="line">    &#123;</span><br><span class="line">        uint winningVoteCount = 0;</span><br><span class="line">        for (uint p = 0; p &lt; proposals.length; p++) &#123;</span><br><span class="line">            if (proposals[p].voteCount &gt; winningVoteCount) &#123;</span><br><span class="line">                winningVoteCount = proposals[p].voteCount;</span><br><span class="line">                winningProposal_ = p;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    // è°ƒç”¨ winningProposal() å‡½æ•°ä»¥è·å–ææ¡ˆæ•°ç»„ä¸­è·èƒœè€…çš„ç´¢å¼•ï¼Œå¹¶ä»¥æ­¤è¿”å›è·èƒœè€…çš„åç§°</span><br><span class="line">    function winnerName() external view</span><br><span class="line">            returns (bytes32 winnerName_)</span><br><span class="line">    &#123;</span><br><span class="line">        winnerName_ = proposals[winningProposal()].name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="æ™®é€šç«æ‹"><a href="#æ™®é€šç«æ‹" class="headerlink" title="æ™®é€šç«æ‹"></a>æ™®é€šç«æ‹</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: GPL-3.0</span><br><span class="line">pragma solidity ^0.8.4;</span><br><span class="line">contract SimpleAuction &#123;</span><br><span class="line">    // æ‹å–çš„å‚æ•°ã€‚æ—¶é—´å¯ä»¥æ˜¯ç»å¯¹çš„ unix æ—¶é—´æˆ³ï¼ˆè‡ª 1970-01-01 èµ·çš„ç§’æ•°ï¼‰æˆ–ä»¥ç§’ä¸ºå•ä½çš„æ—¶é—´æ®µã€‚</span><br><span class="line">    address payable public beneficiary;  // æ ‡è®°è¯¥åœ°å€èƒ½å¤Ÿæ¥æ”¶èµ„é‡‘</span><br><span class="line">    uint public auctionEndTime;</span><br><span class="line"></span><br><span class="line">    // æ‹å–çš„å½“å‰çŠ¶æ€ã€‚</span><br><span class="line">    address public highestBidder;</span><br><span class="line">    uint public highestBid;</span><br><span class="line"></span><br><span class="line">    // å…è®¸å–å›çš„å…ˆå‰å‡ºä»·</span><br><span class="line">    mapping(address =&gt; uint) pendingReturns;</span><br><span class="line"></span><br><span class="line">    // åœ¨ç»“æŸæ—¶è®¾ç½®ä¸º trueï¼Œç¦æ­¢ä»»ä½•æ›´æ”¹ã€‚</span><br><span class="line">    // é»˜è®¤åˆå§‹åŒ–ä¸º `false`ã€‚</span><br><span class="line">    bool ended;</span><br><span class="line"></span><br><span class="line">    // å˜æ›´è§¦å‘çš„äº‹ä»¶ã€‚ äº‹ä»¶å°±æ˜¯åŒºå—é“¾çš„&quot;å¹¿æ’­ç³»ç»Ÿ&quot;ï¼Œå¹¿æ’­å†…å®¹ä¸ºå‚æ•°å†…å®¹ã€‚</span><br><span class="line">    event HighestBidIncreased(address bidder, uint amount);</span><br><span class="line">    event AuctionEnded(address winner, uint amount);</span><br><span class="line"></span><br><span class="line">    // Errors ç”¨æ¥å®šä¹‰å¤±è´¥</span><br><span class="line"></span><br><span class="line">    // ä¸‰æ–œæ æ³¨é‡Šæ˜¯æ‰€è°“çš„ natspec æ³¨é‡Šã€‚</span><br><span class="line">    // å½“ç”¨æˆ·è¢«è¦æ±‚ç¡®è®¤äº¤æ˜“æ—¶å°†æ˜¾ç¤ºå®ƒä»¬ï¼Œæˆ–è€…å½“æ˜¾ç¤ºé”™è¯¯æ—¶ã€‚</span><br><span class="line"></span><br><span class="line">    /// æ‹å–å·²ç»ç»“æŸã€‚</span><br><span class="line">    error AuctionAlreadyEnded();  // revert äº¤æ˜“å›æ»šâ€‹ gas é€€å›ï¼›</span><br><span class="line">    /// å·²ç»æœ‰æ›´é«˜æˆ–ç›¸ç­‰çš„å‡ºä»·ã€‚</span><br><span class="line">    error BidNotHighEnough(uint highestBid);</span><br><span class="line">    /// æ‹å–å°šæœªç»“æŸã€‚</span><br><span class="line">    error AuctionNotYetEnded();</span><br><span class="line">    /// å‡½æ•° auctionEnd å·²ç»è¢«è°ƒç”¨ã€‚</span><br><span class="line">    error AuctionEndAlreadyCalled();</span><br><span class="line"></span><br><span class="line">    /// åˆ›å»ºä¸€ä¸ªç®€å•çš„æ‹å–ï¼Œæ‹å–æ—¶é—´ä¸º `biddingTime`ç§’ï¼Œä»£è¡¨å—ç›Šäººåœ°å€ `beneficiaryAddress`ã€‚</span><br><span class="line">    constructor(</span><br><span class="line">        uint biddingTime,</span><br><span class="line">        address payable beneficiaryAddress</span><br><span class="line">    ) &#123;</span><br><span class="line">        beneficiary = beneficiaryAddress;</span><br><span class="line">        auctionEndTime = block.timestamp + biddingTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /// åœ¨æ‹å–ä¸­å‡ºä»·ï¼Œå‡ºä»·çš„å€¼ä¸æ­¤äº¤æ˜“ä¸€èµ·å‘é€ã€‚</span><br><span class="line">    /// è¯¥å€¼ä»…åœ¨æ‹å–æœªè·èƒœæ—¶é€€æ¬¾ã€‚</span><br><span class="line">    function bid() external payable &#123;</span><br><span class="line">        // ä¸éœ€è¦å‚æ•°ï¼Œæ‰€æœ‰ä¿¡æ¯å·²ç»æ˜¯äº¤æ˜“çš„ä¸€éƒ¨åˆ†ã€‚</span><br><span class="line">        // å…³é”®å­— payable æ˜¯å¿…éœ€çš„ï¼Œä»¥ä¾¿å‡½æ•°èƒ½å¤Ÿæ¥æ”¶ä»¥å¤ªã€‚</span><br><span class="line"></span><br><span class="line">        // å¦‚æœæ‹å–æ—¶é—´å·²è¿‡ï¼Œåˆ™æ’¤é”€è°ƒç”¨ã€‚</span><br><span class="line">        if (block.timestamp &gt; auctionEndTime)</span><br><span class="line">            revert AuctionAlreadyEnded();</span><br><span class="line"></span><br><span class="line">        // å¦‚æœå‡ºä»·ä¸é«˜ï¼Œåˆ™å°†ä»¥å¤ªå¸é€€å›ï¼ˆæ’¤é”€è¯­å¥å°†æ’¤é”€æ­¤å‡½æ•°æ‰§è¡Œä¸­çš„æ‰€æœ‰æ›´æ”¹ï¼ŒåŒ…æ‹¬å®ƒå·²æ¥æ”¶ä»¥å¤ªå¸ï¼‰ã€‚</span><br><span class="line">        if (msg.value &lt;= highestBid)</span><br><span class="line">            revert BidNotHighEnough(highestBid);</span><br><span class="line"></span><br><span class="line">        if (highestBid != 0) &#123;</span><br><span class="line">            // é€šè¿‡ç®€å•ä½¿ç”¨ highestBidder.send(highestBid) é€€å›ä»¥å¤ªå¸æ˜¯ä¸€ä¸ªå®‰å…¨é£é™©ï¼Œå› ä¸ºå®ƒå¯èƒ½ä¼šæ‰§è¡Œä¸€ä¸ªä¸å—ä¿¡ä»»çš„åˆçº¦ã€‚</span><br><span class="line">            // è®©æ¥æ”¶è€…è‡ªè¡Œæå–ä»–ä»¬çš„ä»¥å¤ªå¸æ€»æ˜¯æ›´å®‰å…¨ã€‚</span><br><span class="line">            pendingReturns[highestBidder] += highestBid;</span><br><span class="line">        &#125;</span><br><span class="line">        highestBidder = msg.sender;</span><br><span class="line">        highestBid = msg.value;</span><br><span class="line">        emit HighestBidIncreased(msg.sender, msg.value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /// å–å›å‡ºä»·ï¼ˆå½“è¯¥å‡ºä»·å·²è¢«è¶…è¶Šï¼‰</span><br><span class="line">    function withdraw() external returns (bool) &#123;</span><br><span class="line">        uint amount = pendingReturns[msg.sender];</span><br><span class="line">        if (amount &gt; 0) &#123;</span><br><span class="line">            // å°†å…¶è®¾ç½®ä¸ºé›¶å¾ˆé‡è¦ï¼Œå› ä¸ºæ¥æ”¶è€…å¯ä»¥åœ¨ `send` è¿”å›ä¹‹å‰å†æ¬¡è°ƒç”¨æ­¤å‡½æ•°ä½œä¸ºæ¥æ”¶è°ƒç”¨çš„ä¸€éƒ¨åˆ†ã€‚</span><br><span class="line">            pendingReturns[msg.sender] = 0;</span><br><span class="line"></span><br><span class="line">            // msg.sender ä¸æ˜¯ `address payable` ç±»å‹ï¼Œå¿…é¡»æ˜¾å¼è½¬æ¢ä¸º `payable(msg.sender)` ä»¥ä¾¿ä½¿ç”¨æˆå‘˜å‡½æ•° `send()`ã€‚</span><br><span class="line">            if (!payable(msg.sender).send(amount)) &#123;</span><br><span class="line">                // è¿™é‡Œä¸éœ€è¦è°ƒç”¨ throwï¼Œåªéœ€é‡ç½®æœªä»˜æ¬¾</span><br><span class="line">                pendingReturns[msg.sender] = amount;</span><br><span class="line">                return false;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /// ç»“æŸæ‹å–å¹¶å°†æœ€é«˜å‡ºä»·å‘é€ç»™å—ç›Šäººã€‚</span><br><span class="line">    function auctionEnd() external &#123;</span><br><span class="line">        // è¿™æ˜¯ä¸€ä¸ªå¥½çš„æŒ‡å¯¼åŸåˆ™ï¼Œå°†ä¸å…¶ä»–åˆçº¦äº¤äº’çš„å‡½æ•°ï¼ˆå³å®ƒä»¬è°ƒç”¨å‡½æ•°æˆ–å‘é€ä»¥å¤ªï¼‰ç»“æ„åŒ–ä¸ºä¸‰ä¸ªé˜¶æ®µï¼š</span><br><span class="line">        // 1. æ£€æŸ¥æ¡ä»¶</span><br><span class="line">        // 2. æ‰§è¡Œæ“ä½œï¼ˆå¯èƒ½æ›´æ”¹æ¡ä»¶ï¼‰</span><br><span class="line">        // 3. ä¸å…¶ä»–åˆçº¦äº¤äº’</span><br><span class="line">        // å¦‚æœè¿™äº›é˜¶æ®µæ··åˆåœ¨ä¸€èµ·ï¼Œå…¶ä»–åˆçº¦å¯èƒ½ä¼šå›è°ƒå½“å‰åˆçº¦å¹¶ä¿®æ”¹çŠ¶æ€æˆ–å¯¼è‡´æ•ˆæœï¼ˆä»¥å¤ªæ”¯ä»˜ï¼‰è¢«å¤šæ¬¡æ‰§è¡Œã€‚</span><br><span class="line">        // å¦‚æœå†…éƒ¨è°ƒç”¨çš„å‡½æ•°åŒ…æ‹¬ä¸å¤–éƒ¨åˆçº¦çš„äº¤äº’ï¼Œå®ƒä»¬ä¹Ÿå¿…é¡»è¢«è§†ä¸ºä¸å¤–éƒ¨åˆçº¦çš„äº¤äº’ã€‚</span><br><span class="line"></span><br><span class="line">        // 1. æ¡ä»¶</span><br><span class="line">        if (block.timestamp &lt; auctionEndTime)</span><br><span class="line">            revert AuctionNotYetEnded();</span><br><span class="line">        if (ended)</span><br><span class="line">            revert AuctionEndAlreadyCalled();</span><br><span class="line"></span><br><span class="line">        // 2. ç”Ÿæ•ˆ</span><br><span class="line">        ended = true;</span><br><span class="line">        emit AuctionEnded(highestBidder, highestBid);</span><br><span class="line"></span><br><span class="line">        // 3. äº¤äº’</span><br><span class="line">        beneficiary.transfer(highestBid);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="â€æ£€æŸ¥-ç”Ÿæ•ˆ-äº¤äº’â€-åŸåˆ™"><a href="#â€æ£€æŸ¥-ç”Ÿæ•ˆ-äº¤äº’â€-åŸåˆ™" class="headerlink" title="**â€æ£€æŸ¥-ç”Ÿæ•ˆ-äº¤äº’â€**åŸåˆ™"></a>**â€æ£€æŸ¥-ç”Ÿæ•ˆ-äº¤äº’â€**åŸåˆ™</h2><p>checkã€effectã€interactionã€‚</p>
<p>å¦‚æœè®© interactionäº¤äº’ å‘ç”Ÿåœ¨ effectçŠ¶æ€å˜åŒ–å‰é¢ï¼Œå¯èƒ½å¯¼è‡´<strong>é‡å…¥æ”»å‡»</strong>ã€‚</p>
<p><strong>é‡å…¥æ”»å‡»</strong>å°±æ˜¯åˆ«äººåå¤è°ƒç”¨ä½ çš„ä¸€ä¸ªå‡½æ•°æˆ–è€…æ–¹æ³•ï¼Œå®ç°æ”»å‡»çš„æ–¹æ³•ã€‚ ä¾‹å¦‚ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">if (highestBid != 0) &#123;</span><br><span class="line">    // æ”¹ä¸ºç›´æ¥è½¬è´¦ï¼ˆæ˜“å—æ”»å‡»çš„ç‰ˆæœ¬ï¼‰</span><br><span class="line">    (bool success, ) = highestBidder.call&#123;value: highestBid&#125;(&quot;&quot;);</span><br><span class="line">    require(success, &quot;Transfer failed&quot;);</span><br><span class="line">&#125;</span><br><span class="line">highestBidder = msg.sender;</span><br><span class="line">highestBid = msg.value;</span><br><span class="line">emit HighestBidIncreased(msg.sender, msg.value);</span><br></pre></td></tr></table></figure>

<p>interactionäº¤äº’ï¼ˆå‘è¿™ä¸ªåœ°å€ä¸­è½¬è´¦å…ˆå‘ç”Ÿï¼‰</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(bool success, ) = highestBidder.call&#123;value: highestBid&#125;(&quot;&quot;);</span><br></pre></td></tr></table></figure>

<p>effectçŠ¶æ€åæ”¹å˜</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">highestBidder = msg.sender;</span><br><span class="line">highestBid = msg.value;</span><br></pre></td></tr></table></figure>

<p>å‡å¦‚æ­¤æ—¶æœ‰ä¸€ä¸ª é»‘å®¢åˆçº¦ï¼Œï¼ˆåœ¨è¢«åˆ«çš„åˆçº¦callè°ƒç”¨ æ”¶æ¬¾æ—¶ï¼Œä¼šè‡ªåŠ¨ è¿è¡Œreceiveå‡½æ•°ï¼Œè¿™æ˜¯åŒºå—é“¾è§„åˆ™ï¼‰ï¼Œ</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">receive() external payable &#123;</span><br><span class="line">    // åœ¨æ¥æ”¶ä»¥å¤ªå¸æ—¶ï¼Œé‡æ–°è°ƒç”¨ bid å‡½æ•°ï¼Œå‡ºä»·ç•¥é«˜äºå½“å‰æœ€é«˜ä»·</span><br><span class="line">    auction.bid&#123;value: currentHighestBid + 1 wei&#125;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å®ƒå…ˆå‡ºä»·1ethï¼Œåˆ«äººè¿›ä»·2ethï¼Œå®ƒå°±ä¼šä»¥ä¹‹å‰çš„æœ€é«˜ä»·è¢«è°ƒç”¨<code>highestBidder.call&#123;value: highestBid&#125;(&quot;&quot;)</code>ï¼Œå®ƒåœ¨æ”¶åˆ°1ethé€€æ¬¾åï¼Œæ¥äº†ä¸€ä¸ª é‡æ–°è°ƒç”¨ bid å‡½æ•°çš„æ“ä½œï¼Œè€Œä¸”å‡ºä»·ä»…ä»…æ¯”ä¹‹å‰é«˜ä¸€ç‚¹ç‚¹å¦‚1.001ethã€‚ç”±äºä¹‹å‰çš„  effectçŠ¶æ€æ”¹å˜è¿˜æœªå‘ç”Ÿï¼Œå¯¼è‡´è¿˜æ˜¯ä¹‹å‰è‡ªå·±è€çš„å‡ºä»· 1ethä½œä¸º <code>highestBid</code> ï¼Œè‡ªå·±è¿™é«˜ä¸€ç‚¹ç‚¹çš„ æ–°ç«ä»·ï¼Œèƒ½å¤Ÿé€šè¿‡ bidä¸­ check æ­¥éª¤ <code>if (msg.value &lt;= highestBid)</code> ç­‰ç­‰è¿™äº›æ¡ä»¶ï¼Œç„¶å å†åº¦åˆ·æ–°è‡ªå·±ä¹‹å‰ æœ€é«˜ç«ä»·é€€æ¬¾çš„æ­¥éª¤<code>highestBidder.call&#123;value: highestBid&#125;(&quot;&quot;)</code>,å†æ¬¡æ”¶åˆ° 1ethçš„é€€æ¬¾ï¼Œè€Œå†æ¬¡åœ¨ é»‘å®¢åˆçº¦ä¸­è°ƒç”¨receiveå‡½æ•°ï¼Œå†æ¬¡æ”¶åˆ° 1ethçš„é€€æ¬¾ï¼Œå®ç°é€’å½’ï¼Œç›´åˆ°èŠ±å…‰gas æˆ–è€…åœ¨è‡ªå·±å†™çš„æŸä¸ªæ¡ä»¶åœä¸‹æ¥ã€‚ </p>
<h2 id="ç›²æ‹"><a href="#ç›²æ‹" class="headerlink" title="ç›²æ‹"></a>ç›²æ‹</h2><p><strong>å…·æœ‰çº¦æŸåŠ›ä¸”ä¿å¯†</strong>ï¼šé˜²æ­¢ç«æ ‡è€…åœ¨èµ¢å¾—æ‹å–åä¸å‘é€ä»¥å¤ªå¸çš„å”¯ä¸€æ–¹æ³•æ˜¯è®©ä»–ä»¬åœ¨å‡ºä»·æ—¶ä¸€èµ·å‘é€ï¼Œå“ˆå¸Œå®ç°ä¿å¯†ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: GPL-3.0</span><br><span class="line">pragma solidity ^0.8.4;</span><br><span class="line">contract BlindAuction &#123;</span><br><span class="line">    struct Bid &#123;</span><br><span class="line">        bytes32 blindedBid;</span><br><span class="line">        uint deposit;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    address payable public beneficiary;</span><br><span class="line">    uint public biddingEnd;</span><br><span class="line">    uint public revealEnd;</span><br><span class="line">    bool public ended;</span><br><span class="line"></span><br><span class="line">    mapping(address =&gt; Bid[]) public bids;</span><br><span class="line"></span><br><span class="line">    address public highestBidder;</span><br><span class="line">    uint public highestBid;</span><br><span class="line"></span><br><span class="line">    // å…è®¸æå–ä¹‹å‰å‡ºä»·</span><br><span class="line">    mapping(address =&gt; uint) pendingReturns;</span><br><span class="line"></span><br><span class="line">    event AuctionEnded(address winner, uint highestBid);</span><br><span class="line"></span><br><span class="line">    // Errors ç”¨æ¥å®šä¹‰å¤±è´¥</span><br><span class="line"></span><br><span class="line">    /// å‡½æ•°è¢«è°ƒç”¨å¾—å¤ªæ—©ã€‚</span><br><span class="line">    /// è¯·åœ¨ `time` å†è¯•ä¸€æ¬¡ã€‚</span><br><span class="line">    error TooEarly(uint time);</span><br><span class="line">    /// å‡½æ•°è¢«è°ƒç”¨å¾—å¤ªæ™šã€‚</span><br><span class="line">    /// ä¸èƒ½åœ¨ `time` ä¹‹åè°ƒç”¨ã€‚</span><br><span class="line">    error TooLate(uint time);</span><br><span class="line">    /// å‡½æ•° auctionEnd å·²ç»è¢«è°ƒç”¨ã€‚</span><br><span class="line">    error AuctionEndAlreadyCalled();</span><br><span class="line"></span><br><span class="line">    // ä¿®æ”¹å™¨æ˜¯ä¸€ç§æ–¹ä¾¿çš„æ–¹å¼æ¥éªŒè¯è¾“å…¥å‡½æ•°ã€‚</span><br><span class="line">    // `onlyBefore` åº”ç”¨äºä¸‹é¢çš„ `bid`ï¼šæ–°çš„å‡½æ•°ä½“æ˜¯ä¿®æ”¹å™¨çš„ä¸»ä½“ï¼Œå…¶ä¸­ `_` è¢«æ—§å‡½æ•°ä½“æ›¿æ¢ã€‚</span><br><span class="line">    // solidity ä¸­çš„ modifier æ–¹æ³• å¾ˆåƒ pythonä¸­çš„ @ åé¢çš„è£…é¥°å™¨å•Šï¼Œå°±æ˜¯ä¸€ä¸ª å¯¹è¢«ä¿®é¥°æ–¹æ³•çš„é—­åŒ…å¼çš„ å°è£…ã€‚ </span><br><span class="line">    modifier onlyBefore(uint time) &#123;</span><br><span class="line">        if (block.timestamp &gt;= time) revert TooLate(time);</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line">    modifier onlyAfter(uint time) &#123;</span><br><span class="line">        if (block.timestamp &lt;= time) revert TooEarly(time);</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    constructor(</span><br><span class="line">        uint biddingTime,</span><br><span class="line">        uint revealTime,</span><br><span class="line">        address payable beneficiaryAddress</span><br><span class="line">    ) &#123;</span><br><span class="line">        beneficiary = beneficiaryAddress;</span><br><span class="line">        biddingEnd = block.timestamp + biddingTime;</span><br><span class="line">        revealEnd = biddingEnd + revealTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /// ä»¥ `blindedBid` = keccak256(abi.encodePacked(value, fake, secret)) çš„æ–¹å¼æäº¤ä¸€ä¸ªç›²å‡ºä»·ï¼Œå®ƒæ˜¯ä¸€ä¸ªhashå€¼ã€‚</span><br><span class="line">    /// å‘é€çš„ä»¥å¤ªå¸ä»…åœ¨å‡ºä»·åœ¨æ­ç¤ºé˜¶æ®µè¢«æ­£ç¡®æ­ç¤ºæ—¶æ‰ä¼šé€€è¿˜ã€‚</span><br><span class="line">    /// å¦‚æœä¸å‡ºä»·ä¸€èµ·å‘é€çš„ä»¥å¤ªå¸è‡³å°‘ä¸º &quot;value&quot; ä¸” &quot;fake&quot; ä¸ä¸ºçœŸï¼Œåˆ™å‡ºä»·æœ‰æ•ˆã€‚</span><br><span class="line">    /// å°† &quot;fake&quot; è®¾ç½®ä¸ºçœŸå¹¶å‘é€ä¸å‡†ç¡®çš„é‡‘é¢æ˜¯éšè—çœŸå®å‡ºä»·çš„æ–¹å¼ï¼Œä½†ä»ç„¶æ»¡è¶³æ‰€éœ€çš„å­˜æ¬¾ã€‚</span><br><span class="line">    /// ç›¸åŒåœ°å€å¯ä»¥æäº¤å¤šä¸ªå‡ºä»·ã€‚</span><br><span class="line">    // onlyBefore(biddingEnd) å°±æ˜¯ solidityä½¿ç”¨å‰æ–‡è£…é¥°å™¨çš„å†™æ³•ã€‚ </span><br><span class="line">    function bid(bytes32 blindedBid)</span><br><span class="line">        external</span><br><span class="line">        payable</span><br><span class="line">        onlyBefore(biddingEnd)</span><br><span class="line">    &#123;</span><br><span class="line">        bids[msg.sender].push(Bid(&#123;</span><br><span class="line">            blindedBid: blindedBid,</span><br><span class="line">            deposit: msg.value</span><br><span class="line">        &#125;));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /// ç”¨æˆ·è‡ªå·±æ¥æ­ç¤ºç›²å‡ºä»·ã€‚</span><br><span class="line">    /// å°†è·å¾—æ‰€æœ‰æ­£ç¡®ç›²å‡ºçš„æ— æ•ˆå‡ºä»·çš„é€€æ¬¾ï¼Œä»¥åŠé™¤äº†æœ€é«˜å‡ºä»·ä¹‹å¤–çš„æ‰€æœ‰å‡ºä»·ã€‚</span><br><span class="line">    // åœ¨ Solidity ä¸­ï¼Œå‡½æ•°å‚æ•°æœ‰ä¸‰ç§å­˜å‚¨ä½ç½®ï¼š</span><br><span class="line">    // memory- æ˜“å¤±æ€§å†…å­˜ï¼ˆå¯ä¿®æ”¹ï¼‰</span><br><span class="line">    // storage- æ°¸ä¹…å­˜å‚¨ï¼ˆå¯ä¿®æ”¹ï¼‰</span><br><span class="line">    // calldata- åªè¯»è°ƒç”¨æ•°æ®ï¼ˆä¸å¯ä¿®æ”¹ï¼‰</span><br><span class="line">    function reveal(</span><br><span class="line">        uint[] calldata values,</span><br><span class="line">        bool[] calldata fakes,</span><br><span class="line">        bytes32[] calldata secrets</span><br><span class="line">    )</span><br><span class="line">        external</span><br><span class="line">        onlyAfter(biddingEnd)</span><br><span class="line">        onlyBefore(revealEnd)</span><br><span class="line">    &#123;</span><br><span class="line">        uint length = bids[msg.sender].length;</span><br><span class="line">        require(values.length == length);</span><br><span class="line">        require(fakes.length == length);</span><br><span class="line">        require(secrets.length == length);</span><br><span class="line"></span><br><span class="line">        uint refund; // é€€æ¬¾</span><br><span class="line">        for (uint i = 0; i &lt; length; i++) &#123;</span><br><span class="line">            Bid storage bidToCheck = bids[msg.sender][i]; // å…¬ç¤ºæ•°æ®æ˜¯é“¾ä¸Šè¦è®°å½•çš„ã€‚</span><br><span class="line">            // è·å–ç”¨æˆ·æäº¤çš„æ­ç¤ºæ•°æ®</span><br><span class="line">            (uint value, bool fake, bytes32 secret) =</span><br><span class="line">                    (values[i], fakes[i], secrets[i]);</span><br><span class="line">            if (bidToCheck.blindedBid != keccak256(abi.encodePacked(value, fake, secret))) &#123;</span><br><span class="line">                // å‡ºä»·æœªèƒ½æ­£ç¡®æŠ«éœ²</span><br><span class="line">                // ä¸é€€è¿˜å­˜æ¬¾ã€‚</span><br><span class="line">                continue;</span><br><span class="line">            &#125;</span><br><span class="line">            refund += bidToCheck.deposit;</span><br><span class="line">            // å¦‚æœæ˜¯çœŸå®å‡ºä»·ä¸”æŠ¼é‡‘&gt;=å‡ºä»·é‡‘é¢</span><br><span class="line">            if (!fake &amp;&amp; bidToCheck.deposit &gt;= value) &#123;</span><br><span class="line">                if (placeBid(msg.sender, value))</span><br><span class="line">                    refund -= value;</span><br><span class="line">            &#125;</span><br><span class="line">            // ä½¿å‘é€è€…æ— æ³•é‡æ–°å–å›ç›¸åŒçš„å­˜æ¬¾ã€‚å¦‚æœæ²¡æœ‰è¿™ä¸€æ­¥ï¼Œç”¨æˆ·å†è°ƒç”¨ revealå‡½æ•°ï¼Œåˆä¼šé€€ä¸€éï¼Œè¿™ä¸€æ­¥çš„ç›®çš„ç›¸å½“äºæ’¤é”€æ‰¿è¯ºã€‚</span><br><span class="line">            bidToCheck.blindedBid = bytes32(0);</span><br><span class="line">        &#125;</span><br><span class="line">        payable(msg.sender).transfer(refund);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /// æå–è¢«è¶…å‡ºå‡ºä»·çš„å‡ºä»·ã€‚</span><br><span class="line">    function withdraw() external &#123;</span><br><span class="line">        uint amount = pendingReturns[msg.sender];</span><br><span class="line">        if (amount &gt; 0) &#123;</span><br><span class="line">            // å°†å…¶è®¾ç½®ä¸ºé›¶æ˜¯é‡è¦çš„ï¼Œ</span><br><span class="line">            // å› ä¸ºï¼Œä½œä¸ºæ¥æ”¶è°ƒç”¨çš„ä¸€éƒ¨åˆ†ï¼Œ</span><br><span class="line">            // æ¥æ”¶è€…å¯ä»¥åœ¨ `transfer` è¿”å›ä¹‹å‰é‡æ–°è°ƒç”¨è¯¥å‡½æ•°ã€‚ï¼ˆå¯æŸ¥çœ‹ä¸Šé¢å…³äºâ€œæ¡ä»¶ -&gt; ç”Ÿæ•ˆ -&gt; äº¤äº’â€çš„æ ‡æ³¨ï¼‰</span><br><span class="line">            pendingReturns[msg.sender] = 0;</span><br><span class="line"></span><br><span class="line">            payable(msg.sender).transfer(amount);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /// ç»“æŸæ‹å–å¹¶å°†æœ€é«˜å‡ºä»·å‘é€ç»™å—ç›Šäººã€‚</span><br><span class="line">    function auctionEnd()</span><br><span class="line">        external</span><br><span class="line">        onlyAfter(revealEnd)</span><br><span class="line">    &#123;</span><br><span class="line">        if (ended) revert AuctionEndAlreadyCalled(); // ended åœ¨ä¸€å¼€å§‹ é»˜è®¤æ˜¯0 ä¹Ÿå°±æ˜¯ false é»˜è®¤æ²¡æœ‰ç»“æŸã€‚</span><br><span class="line">        emit AuctionEnded(highestBidder, highestBid);</span><br><span class="line">        ended = true;                                // é”ä½äº†ã€‚ä¸èƒ½åå¤ ç»™å—ç›Šäººæ‰“é’±ã€‚</span><br><span class="line">        beneficiary.transfer(highestBid);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // è¿™æ˜¯ä¸€ä¸ªâ€œå†…éƒ¨â€å‡½æ•°ï¼Œè¿™æ„å‘³ç€å®ƒåªèƒ½ä»åˆçº¦æœ¬èº«ï¼ˆæˆ–ä»æ´¾ç”Ÿåˆçº¦ï¼‰è°ƒç”¨ã€‚</span><br><span class="line">    function placeBid(address bidder, uint value) internal</span><br><span class="line">            returns (bool success)</span><br><span class="line">    &#123;</span><br><span class="line">        if (value &lt;= highestBid) &#123;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">        if (highestBidder != address(0)) &#123;</span><br><span class="line">            // é€€æ¬¾ç»™ä¹‹å‰çš„æœ€é«˜å‡ºä»·è€…ã€‚</span><br><span class="line">            pendingReturns[highestBidder] += highestBid;</span><br><span class="line">        &#125;</span><br><span class="line">        highestBid = value;</span><br><span class="line">        highestBidder = bidder;</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="è¿œç¨‹è´­ä¹°"><a href="#è¿œç¨‹è´­ä¹°" class="headerlink" title="è¿œç¨‹è´­ä¹°"></a>è¿œç¨‹è´­ä¹°</h2><p>åŒæ–¹å¿…é¡»å°†ç‰©å“ä»·å€¼çš„ä¸¤å€æ”¾å…¥åˆçº¦ä½œä¸ºæ‰˜ç®¡ã€‚ ä¸€æ—¦å‘ç”ŸçŠ¶å†µï¼Œä»¥å¤ªå¸å°†è¢«é”å®šåœ¨åˆçº¦ä¸­ï¼Œç›´åˆ°ä¹°æ–¹ç¡®è®¤ä»–ä»¬æ”¶åˆ°äº†ç‰©å“ã€‚ ä¹‹åï¼Œä¹°æ–¹å°†è·å¾—ä»·å€¼ï¼ˆä»–ä»¬å­˜æ¬¾çš„ä¸€åŠï¼‰ï¼Œè€Œå–æ–¹å°†è·å¾—ä¸‰å€çš„ä»·å€¼ï¼ˆä»–ä»¬çš„å­˜æ¬¾åŠ ä¸Šä»·å€¼ï¼‰ã€‚ å…¶èƒŒåçš„æƒ³æ³•æ˜¯åŒæ–¹éƒ½æœ‰åŠ¨åŠ›æ¥è§£å†³è¿™ç§æƒ…å†µï¼Œå¦åˆ™ä»–ä»¬çš„ä»¥å¤ªå¸å°†æ°¸è¿œè¢«é”å®šã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: GPL-3.0</span><br><span class="line">pragma solidity ^0.8.4;</span><br><span class="line">contract Purchase &#123;</span><br><span class="line">    uint public value;</span><br><span class="line">    address payable public seller;</span><br><span class="line">    address payable public buyer;</span><br><span class="line"></span><br><span class="line">    enum State &#123; Created, Locked, Release, Inactive &#125; // å®šä¹‰ä¸€ä¸ªæšä¸¾ç±»</span><br><span class="line">    // çŠ¶æ€å˜é‡çš„é»˜è®¤å€¼ä¸ºç¬¬ä¸€ä¸ªæˆå‘˜ï¼Œ`State.created`</span><br><span class="line">    State public state;</span><br><span class="line"></span><br><span class="line">    modifier condition(bool condition_) &#123;</span><br><span class="line">        require(condition_);</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /// åªæœ‰ä¹°æ–¹å¯ä»¥è°ƒç”¨æ­¤å‡½æ•°ã€‚</span><br><span class="line">    error OnlyBuyer();</span><br><span class="line">    /// åªæœ‰å–æ–¹å¯ä»¥è°ƒç”¨æ­¤å‡½æ•°ã€‚</span><br><span class="line">    error OnlySeller();</span><br><span class="line">    /// å½“å‰çŠ¶æ€ä¸‹æ— æ³•è°ƒç”¨è¯¥å‡½æ•°ã€‚</span><br><span class="line">    error InvalidState();</span><br><span class="line">    /// æä¾›çš„å€¼å¿…é¡»æ˜¯å¶æ•°ã€‚</span><br><span class="line">    error ValueNotEven();</span><br><span class="line"></span><br><span class="line">    modifier onlyBuyer() &#123;</span><br><span class="line">        if (msg.sender != buyer)</span><br><span class="line">            revert OnlyBuyer();</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    modifier onlySeller() &#123;</span><br><span class="line">        if (msg.sender != seller)</span><br><span class="line">            revert OnlySeller();</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    modifier inState(State state_) &#123;</span><br><span class="line">        if (state != state_)</span><br><span class="line">            revert InvalidState();</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    event Aborted();</span><br><span class="line">    event PurchaseConfirmed();</span><br><span class="line">    event ItemReceived();</span><br><span class="line">    event SellerRefunded();</span><br><span class="line"></span><br><span class="line">    // ç¡®ä¿ `msg.value` æ˜¯ä¸€ä¸ªå¶æ•°ã€‚</span><br><span class="line">    // å¦‚æœæ˜¯å¥‡æ•°ï¼Œé™¤æ³•å°†æˆªæ–­ã€‚</span><br><span class="line">    // é€šè¿‡ä¹˜æ³•æ£€æŸ¥å®ƒä¸æ˜¯å¥‡æ•°ã€‚</span><br><span class="line">    constructor() payable &#123;</span><br><span class="line">        seller = payable(msg.sender);</span><br><span class="line">        value = msg.value / 2;</span><br><span class="line">        if ((2 * value) != msg.value)</span><br><span class="line">            revert ValueNotEven();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /// ä¸­æ­¢è´­ä¹°å¹¶æ”¶å›ä»¥å¤ªå¸ã€‚</span><br><span class="line">    /// åªèƒ½ç”±å–æ–¹åœ¨åˆçº¦è¢«é”å®šä¹‹å‰è°ƒç”¨ã€‚</span><br><span class="line">    function abort()</span><br><span class="line">        external</span><br><span class="line">        onlySeller</span><br><span class="line">        inState(State.Created)</span><br><span class="line">    &#123;</span><br><span class="line">        emit Aborted();</span><br><span class="line">        state = State.Inactive;</span><br><span class="line">        // æˆ‘ä»¬åœ¨è¿™é‡Œç›´æ¥ä½¿ç”¨è½¬è´¦ã€‚</span><br><span class="line">        // å¯ç”¨äºé˜²æ­¢é‡å…¥ï¼Œå› ä¸ºå®ƒæ˜¯æ­¤å‡½æ•°ä¸­çš„æœ€åä¸€ä¸ªè°ƒç”¨ï¼Œæˆ‘ä»¬å·²ç»æ”¹å˜äº†çŠ¶æ€ã€‚</span><br><span class="line">        seller.transfer(address(this).balance);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /// ä½œä¸ºä¹°æ–¹ç¡®è®¤è´­ä¹°ã€‚</span><br><span class="line">    /// äº¤æ˜“å¿…é¡»åŒ…æ‹¬ `2 * value` ä»¥å¤ªå¸ã€‚</span><br><span class="line">    /// ä»¥å¤ªå¸å°†åœ¨è°ƒç”¨ confirmReceived ä¹‹å‰è¢«é”å®šã€‚</span><br><span class="line">    function confirmPurchase()</span><br><span class="line">        external</span><br><span class="line">        inState(State.Created)</span><br><span class="line">        condition(msg.value == (2 * value))</span><br><span class="line">        payable</span><br><span class="line">    &#123;</span><br><span class="line">        emit PurchaseConfirmed();</span><br><span class="line">        buyer = payable(msg.sender);</span><br><span class="line">        state = State.Locked;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /// ç¡®è®¤ä½ ï¼ˆä¹°æ–¹ï¼‰æ”¶åˆ°äº†ç‰©å“ã€‚</span><br><span class="line">    /// è¿™å°†é‡Šæ”¾é”å®šçš„ä»¥å¤ªå¸ã€‚</span><br><span class="line">    function confirmReceived()</span><br><span class="line">        external</span><br><span class="line">        onlyBuyer</span><br><span class="line">        inState(State.Locked)</span><br><span class="line">    &#123;</span><br><span class="line">        emit ItemReceived();</span><br><span class="line">        // é¦–å…ˆæ”¹å˜çŠ¶æ€æ˜¯å¾ˆé‡è¦çš„ï¼Œ</span><br><span class="line">        // å¦åˆ™ï¼Œä½¿ç”¨ `send` è°ƒç”¨çš„åˆçº¦å¯ä»¥å†æ¬¡è°ƒç”¨è¿™é‡Œã€‚</span><br><span class="line">        state = State.Release;</span><br><span class="line"></span><br><span class="line">        buyer.transfer(value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /// æ­¤å‡½æ•°é€€æ¬¾ç»™å–æ–¹ï¼Œå³é€€è¿˜å–æ–¹çš„é”å®šèµ„é‡‘ã€‚</span><br><span class="line">    function refundSeller()</span><br><span class="line">        external</span><br><span class="line">        onlySeller</span><br><span class="line">        inState(State.Release)</span><br><span class="line">    &#123;</span><br><span class="line">        emit SellerRefunded();</span><br><span class="line">        // é¦–å…ˆæ”¹å˜çŠ¶æ€æ˜¯å¾ˆé‡è¦çš„ï¼Œ</span><br><span class="line">        // å¦åˆ™ï¼Œä½¿ç”¨ `send` è°ƒç”¨çš„åˆçº¦å¯ä»¥å†æ¬¡è°ƒç”¨è¿™é‡Œã€‚</span><br><span class="line">        state = State.Inactive;</span><br><span class="line"></span><br><span class="line">        seller.transfer(3 * value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="å¾®æ”¯ä»˜é€šé“"><a href="#å¾®æ”¯ä»˜é€šé“" class="headerlink" title="å¾®æ”¯ä»˜é€šé“"></a>å¾®æ”¯ä»˜é€šé“</h2><p>å¯¹äºæ²¡æœ‰æ¥è§¦è¿‡åŒºå—é“¾çš„äººæ¥è¯´åº”è¯¥å…ˆçœ‹çœ‹ä¸‹é¢è¿™ä¸ªé€šä¿—çš„è§£é‡Šæ¥ç†è§£ä¸€ä¸‹ ã€å¾®æ”¯ä»˜é€šé“ã€‘çš„æ„æ€ï¼›</p>
<h3 id="ï¼ˆä¸€ï¼‰é€šä¿—çš„ä¾‹å­ï¼ˆæ–°äººå¿…çœ‹ï¼‰"><a href="#ï¼ˆä¸€ï¼‰é€šä¿—çš„ä¾‹å­ï¼ˆæ–°äººå¿…çœ‹ï¼‰" class="headerlink" title="ï¼ˆä¸€ï¼‰é€šä¿—çš„ä¾‹å­ï¼ˆæ–°äººå¿…çœ‹ï¼‰"></a>ï¼ˆä¸€ï¼‰é€šä¿—çš„ä¾‹å­ï¼ˆæ–°äººå¿…çœ‹ï¼‰</h3><p>æ¯”å–»åœºæ™¯ï¼šä½ å»å’–å•¡åº—å–å’–å•¡ï¼ˆå¾®æ”¯ä»˜é€šé“ï¼‰</p>
<p>ä½ æ¯å¤©éƒ½å»åŒä¸€å®¶å’–å•¡åº—ï¼Œç‚¹å’–å•¡ä»·æ ¼æ˜¯ <strong>10 å…ƒ</strong>ã€‚</p>
<p>ä½†æ˜¯â€”â€”æ¯æ¬¡éƒ½ç”¨åŒºå—é“¾æ”¯ä»˜å¤ªæ…¢ã€å¤ªè´µï¼ˆGasï¼‰ã€‚<br> æ‰€ä»¥ä½ å’Œåº—ä¸»æƒ³å‡ºä¸€ä¸ªåŠæ³•ï¼š<strong>å…ˆå¼€ä¸€ä¸ªâ€œè®°è´¦æœ¬â€</strong>ï¼ˆé€šé“ï¼‰ï¼Œåªåœ¨å¼€å§‹å’Œç»“æŸæ—¶ä¸Šé“¾ï¼Œä¸­é—´çš„æ¯ä¸€æ¯å’–å•¡éƒ½ç¦»çº¿ç»“ç®—ã€‚</p>
<hr>
<h4 id="ğŸª™-ç¬¬ä¸€æ­¥ï¼šå¼€é€šé€šé“ï¼ˆä¸Šé“¾ï¼‰"><a href="#ğŸª™-ç¬¬ä¸€æ­¥ï¼šå¼€é€šé€šé“ï¼ˆä¸Šé“¾ï¼‰" class="headerlink" title="ğŸª™ ç¬¬ä¸€æ­¥ï¼šå¼€é€šé€šé“ï¼ˆä¸Šé“¾ï¼‰"></a>ğŸª™ ç¬¬ä¸€æ­¥ï¼šå¼€é€šé€šé“ï¼ˆä¸Šé“¾ï¼‰</h4><p>ä½ å’Œå’–å•¡åº—è€æ¿åœ¨åŒºå—é“¾ä¸Šç­¾äº†ä¸€ä¸ªâ€œåˆçº¦â€ï¼š</p>
<blockquote>
<p>ã€Œæˆ‘å…ˆåœ¨åˆçº¦é‡Œå­˜ 100 å…ƒï¼Œä»£è¡¨æˆ‘æœªæ¥æœ€å¤šèƒ½å– 10 æ¯å’–å•¡ã€‚ã€</p>
</blockquote>
<p>è¿™ç¬” 100 å…ƒæ˜¯<strong>æŠ¼é‡‘</strong>ï¼Œå†™è¿›åŒºå—é“¾é‡Œã€‚</p>
<hr>
<h4 id="âœï¸-ç¬¬äºŒæ­¥ï¼šç¦»çº¿ç­¾åï¼ˆç¦»é“¾æ”¯ä»˜ï¼‰"><a href="#âœï¸-ç¬¬äºŒæ­¥ï¼šç¦»çº¿ç­¾åï¼ˆç¦»é“¾æ”¯ä»˜ï¼‰" class="headerlink" title="âœï¸ ç¬¬äºŒæ­¥ï¼šç¦»çº¿ç­¾åï¼ˆç¦»é“¾æ”¯ä»˜ï¼‰"></a>âœï¸ ç¬¬äºŒæ­¥ï¼šç¦»çº¿ç­¾åï¼ˆç¦»é“¾æ”¯ä»˜ï¼‰</h4><p>ä½ å–ç¬¬ä¸€æ¯å’–å•¡ã€‚<br> è€æ¿è¦ä½ â€œç­¾ä¸ªå­—â€è¡¨ç¤ºã€Œæˆ‘æ‰¿è®¤è¿™æ¯å’–å•¡èŠ±äº† 10 å…ƒã€ã€‚</p>
<p>äºæ˜¯ä½ å†™äº†ä¸€å¼ <strong>ç­¾ç½²çš„å‡­è¯</strong>ï¼š</p>
<figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">æˆ‘ï¼ˆå®¢æˆ·ï¼‰åŒæ„æ”¯ä»˜è€æ¿<span class="number"> 10 </span>å…ƒã€‚</span><br><span class="line">ç­¾åï¼šYushao</span><br></pre></td></tr></table></figure>

<blockquote>
<p>è¿™å¼ â€œç­¾åå‡­è¯â€ä¸éœ€è¦ä¸Šé“¾ï¼Œåªå­˜åœ¨ä½ å’Œè€æ¿ä¹‹é—´ã€‚</p>
</blockquote>
<p>å–ç¬¬äºŒæ¯æ—¶ï¼Œä½ å†å†™ï¼š</p>
<figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">æˆ‘åŒæ„æ”¯ä»˜è€æ¿<span class="number"> 20 </span>å…ƒã€‚</span><br><span class="line">ç­¾åï¼šYushao</span><br></pre></td></tr></table></figure>

<p>è¡¨ç¤ºï¼š<strong>æˆªæ­¢ç›®å‰</strong>æˆ‘æ¬ ä»– 20 å…ƒï¼ˆç´¯è®¡çš„ï¼‰ã€‚</p>
<blockquote>
<p>å¦‚æœè¦åŠ ä¸Šä¸€äº›å¤æ‚çš„å‚æ•°æ¥ç»„è£…å‡ºç­¾åçš„å†…å®¹</p>
</blockquote>
<blockquote>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">æˆ‘æ¬  è€æ¿å¼ ä¸‰ï¼ˆrecipientï¼‰çš„ é’±ï¼ˆamountï¼‰æ˜¯ 20 å…ƒï¼Œ</span><br><span class="line">å‡­è¯ç¼–å·ï¼ˆnonceï¼‰æ˜¯ 3ï¼Œ</span><br><span class="line">è¿™ä»½å‡­è¯å±äº åˆåŒå· #AABBCCï¼ˆcontractAddressï¼‰</span><br><span class="line">ç­¾åï¼šYushao</span><br></pre></td></tr></table></figure>
</blockquote>
<hr>
<h4 id="ğŸ”-â€œç­¾ç½²å†…å®¹â€åˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#ğŸ”-â€œç­¾ç½²å†…å®¹â€åˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="ğŸ” â€œç­¾ç½²å†…å®¹â€åˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿ"></a>ğŸ” â€œç­¾ç½²å†…å®¹â€åˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿ</h4><p>ç­¾ç½²çš„ä¸æ˜¯â€œæ–‡å­—â€ï¼Œè€Œæ˜¯ä¸€æ®µæ•°æ®çš„å“ˆå¸Œã€‚<br> ä½†ä½ å¯ä»¥æŠŠå®ƒç†è§£æˆæ˜¯å¯¹è¿™å¥è¯ç­¾åï¼š</p>
<blockquote>
<p>â€œå¦‚æœè¿™å¼ å•æ®ï¼ˆä½™é¢&#x3D;20å…ƒï¼‰æ˜¯æˆ‘ç­¾çš„ï¼Œé‚£æˆ‘ç¡®å®æˆæƒæ”¯ä»˜è¿™ä¹ˆå¤šã€‚â€</p>
</blockquote>
<p>è€æ¿æ”¶åˆ°åï¼Œä»–è‡ªå·±ä¸èƒ½æ”¹æˆâ€œä½™é¢&#x3D;30å…ƒâ€ï¼Œå› ä¸ºé‚£ä¼šå¯¼è‡´ç­¾åéªŒè¯å¤±è´¥ã€‚</p>
<p>âœ… <strong>ç­¾åè¯æ˜äº†ä½ ç¡®å®è¯´è¿‡è¿™å¥è¯ã€‚</strong></p>
<hr>
<h4 id="ğŸ’¡-ç¬¬ä¸‰æ­¥ï¼šé€šé“ç»“ç®—ï¼ˆä¸Šé“¾ä¸€æ¬¡ï¼‰"><a href="#ğŸ’¡-ç¬¬ä¸‰æ­¥ï¼šé€šé“ç»“ç®—ï¼ˆä¸Šé“¾ä¸€æ¬¡ï¼‰" class="headerlink" title="ğŸ’¡ ç¬¬ä¸‰æ­¥ï¼šé€šé“ç»“ç®—ï¼ˆä¸Šé“¾ä¸€æ¬¡ï¼‰"></a>ğŸ’¡ ç¬¬ä¸‰æ­¥ï¼šé€šé“ç»“ç®—ï¼ˆä¸Šé“¾ä¸€æ¬¡ï¼‰</h4><p>å½“ä½ å–å®Œæœ€åä¸€æ¯ã€æˆ–è€…ä¸æƒ³ç»§ç»­å–äº†ï¼Œ<br> è€æ¿æŠŠä½ æœ€åä¸€å¼ â€œç­¾åå‡­è¯â€æ‹¿å»é“¾ä¸Šï¼š</p>
<blockquote>
<p>ã€Œé“¾ä¸Šåˆçº¦ï¼Œè¯·æ ¹æ®è¿™ä»½ç­¾åæ”¯ä»˜æˆ‘ 50 å…ƒã€‚ã€</p>
</blockquote>
<p>åˆçº¦éªŒè¯ç­¾åç¡®å®æ˜¯ä½ çš„ â†’ ç»™è€æ¿è½¬ 50 å…ƒ â†’ æŠŠå‰©ä¸‹çš„ 50 å…ƒè¿˜ä½ ã€‚<br> æ•´ä¸ªè¿‡ç¨‹ä¸­ï¼Œ<strong>åªæœ‰ä¸¤æ¬¡ä¸Šé“¾</strong>ï¼š</p>
<ol>
<li>å¼€é€šé€šé“ï¼ˆå­˜é’±ï¼‰</li>
<li>å…³é—­é€šé“ï¼ˆç»“ç®—ï¼‰</li>
</ol>
<p>ä¸­é—´é‚£ 10 æ¬¡ç¦»çº¿ç­¾åéƒ½æ²¡èŠ± Gasã€‚</p>
<h3 id="ï¼ˆäºŒï¼‰å®˜ç½‘çš„ä¾‹å­"><a href="#ï¼ˆäºŒï¼‰å®˜ç½‘çš„ä¾‹å­" class="headerlink" title="ï¼ˆäºŒï¼‰å®˜ç½‘çš„ä¾‹å­"></a>ï¼ˆäºŒï¼‰å®˜ç½‘çš„ä¾‹å­</h3><p>ä¾‹å­ä¸­ä½¿ç”¨åŠ å¯†ç­¾åï¼Œä½¿ä»¥å¤ªå¸åœ¨åŒä¸€å½“äº‹äººä¹‹é—´çš„é‡å¤è½¬ç§»å˜å¾—å®‰å…¨ã€å³æ—¶ï¼Œå¹¶ä¸”æ²¡æœ‰äº¤æ˜“è´¹ç”¨ã€‚ </p>
<p>Aliceæƒ³å‘é€ä¸€äº›ä»¥å¤ªç»™Bobï¼Œ å³Aliceæ˜¯å‘é€æ–¹ï¼ŒBobæ˜¯æ¥æ”¶æ–¹ã€‚</p>
<p>Alice åªéœ€è¦åœ¨é“¾ä¸‹å‘é€ç»è¿‡åŠ å¯†ç­¾åçš„ä¿¡æ¯ (ä¾‹å¦‚é€šè¿‡ç”µå­é‚®ä»¶)ç»™Bobï¼Œå®ƒç±»ä¼¼äºå†™æ”¯ç¥¨ã€‚</p>
<p>Aliceå’ŒBobä½¿ç”¨ç­¾åæ¥æˆæƒäº¤æ˜“ï¼Œè¿™åœ¨ä»¥å¤ªåŠçš„æ™ºèƒ½åˆçº¦ä¸­æ˜¯å¯ä»¥å®ç°çš„ã€‚ Aliceå°†å»ºç«‹ä¸€ä¸ªç®€å•çš„æ™ºèƒ½åˆçº¦ï¼Œè®©å¥¹ä¼ è¾“ä»¥å¤ªå¸ï¼Œä½†å¥¹ä¸ä¼šè‡ªå·±è°ƒç”¨ä¸€ä¸ªå‡½æ•°æ¥å¯åŠ¨ä»˜æ¬¾ï¼Œ è€Œæ˜¯è®©Bobæ¥åšï¼Œä»è€Œæ”¯ä»˜äº¤æ˜“è´¹ç”¨ã€‚</p>
<p>è¯¥åˆçº¦å°†æŒ‰ä»¥ä¸‹æ–¹å¼è¿ä½œï¼š</p>
<ul>
<li><p>Aliceéƒ¨ç½²äº† ReceiverPays åˆçº¦ï¼Œé™„åŠ äº†è¶³å¤Ÿçš„ä»¥å¤ªå¸æ¥æ”¯ä»˜å°†è¦è¿›è¡Œçš„ä»˜æ¬¾ã€‚</p>
</li>
<li><p>Aliceé€šè¿‡ç”¨å¥¹çš„ç§é’¥ç­¾ç½²ä¸€ä¸ªæ¶ˆæ¯æ¥æˆæƒä»˜æ¬¾ã€‚</p>
</li>
<li><p>Aliceå°†ç»è¿‡åŠ å¯†ç­¾åçš„ä¿¡æ¯å‘é€ç»™Bobã€‚è¯¥ä¿¡æ¯ä¸éœ€è¦ä¿å¯†ï¼ˆåé¢ä¼šè§£é‡Šï¼‰ï¼Œè€Œä¸”å‘é€æœºåˆ¶ä¹Ÿä¸é‡è¦ã€‚</p>
</li>
<li><p>Bobé€šè¿‡å‘æ™ºèƒ½åˆçº¦å‘é€ç­¾åçš„ä¿¡æ¯æ¥ç´¢å–ä»–çš„ä»˜æ¬¾ï¼Œåˆçº¦éªŒè¯äº†ä¿¡æ¯çš„çœŸå®æ€§ï¼Œç„¶åé‡Šæ”¾èµ„é‡‘ã€‚</p>
</li>
</ul>
<h4 id="åˆ›å»ºç­¾å"><a href="#åˆ›å»ºç­¾å" class="headerlink" title="åˆ›å»ºç­¾å"></a>åˆ›å»ºç­¾å</h4><p>Aliceä¸éœ€è¦ä¸ä»¥å¤ªåŠç½‘ç»œäº¤äº’æ¥ç­¾ç½²äº¤æ˜“ï¼Œè¿™ä¸ªè¿‡ç¨‹æ˜¯å®Œå…¨ç¦»çº¿çš„ã€‚ æˆ‘ä»¬å°†ä½¿ç”¨ <a target="_blank" rel="noopener" href="https://github.com/web3/web3.js">web3.js</a> å’Œ <a target="_blank" rel="noopener" href="https://metamask.io/">MetaMask</a> åœ¨æµè§ˆå™¨ä¸­ç­¾ç½²ä¿¡æ¯ã€‚</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// å…ˆè¿›è¡Œå“ˆå¸Œè¿ç®—ä½¿äº‹æƒ…å˜å¾—æ›´å®¹æ˜“</span></span><br><span class="line"><span class="keyword">var</span> hash = web3.<span class="property">utils</span>.<span class="title function_">sha3</span>(<span class="string">&quot;message to sign&quot;</span>);</span><br><span class="line">web3.<span class="property">eth</span>.<span class="property">personal</span>.<span class="title function_">sign</span>(hash, web3.<span class="property">eth</span>.<span class="property">defaultAccount</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Signed&quot;</span>); &#125;);</span><br><span class="line"><span class="comment">/// web3.eth.personal.sign æŠŠä¿¡æ¯çš„é•¿åº¦åŠ åˆ°ç­¾åæ•°æ®ä¸­ã€‚ ï¼ˆè¿™é‡Œæ˜¯ web3.eth.defaultAccountï¼‰å¯¹ hash è¿›è¡Œç­¾åã€‚personal.sign æ˜¯ JSON-RPC personal_sign çš„å°è£…ã€‚ç­¾åä¼šè¿”å›ä¸€ä¸ª signatureï¼ˆé€šå¸¸åœ¨ callback çš„å‚æ•°ä¸­ï¼‰ï¼Œè¿™é‡Œç¤ºä¾‹åªæ‰“å° â€œSignedâ€ã€‚</span></span><br></pre></td></tr></table></figure>

<h4 id="ç­¾ç½²å†…å®¹"><a href="#ç­¾ç½²å†…å®¹" class="headerlink" title="ç­¾ç½²å†…å®¹"></a>ç­¾ç½²å†…å®¹</h4><p>å¯¹äºå±¥è¡Œä»˜æ¬¾çš„åˆçº¦ï¼Œç­¾ç½²çš„ä¿¡æ¯å¿…é¡»åŒ…æ‹¬ï¼š</p>
<blockquote>
<ol>
<li>æ”¶ä»¶äººçš„é’±åŒ…åœ°å€ã€‚</li>
<li>è¦è½¬ç§»çš„é‡‘é¢ã€‚</li>
<li>é‡æ”¾æ”»å‡»çš„ä¿æŠ¤ã€‚</li>
</ol>
</blockquote>
<p>é‡æ”¾æ”»å‡»æ˜¯æŒ‡ä¸€ä¸ªå·²ç­¾ç½²çš„ä¿¡æ¯è¢«é‡å¤ä½¿ç”¨ï¼Œä»¥è·å¾—å¯¹ç¬¬äºŒæ¬¡äº¤æ˜“çš„æˆæƒã€‚ ä¸ºäº†é¿å…é‡æ”¾æ”»å‡»ï¼Œæˆ‘ä»¬ä½¿ç”¨ä¸ä»¥å¤ªåŠäº¤æ˜“æœ¬èº«ç›¸åŒçš„æŠ€æœ¯ï¼Œ å³æ‰€è°“çš„nonceï¼Œå®ƒæ˜¯ä¸€ä¸ªè´¦æˆ·å‘é€çš„äº¤æ˜“æ•°é‡ã€‚ æ™ºèƒ½åˆçº¦ä¼šæ£€æŸ¥ä¸€ä¸ªnonceæ˜¯å¦è¢«å¤šæ¬¡ä½¿ç”¨ã€‚</p>
<p>å¦ä¸€ç§ç±»å‹çš„é‡æ”¾æ”»å‡»å¯èƒ½å‘ç”Ÿåœ¨æ‰€æœ‰è€…éƒ¨ç½² <code>ReceiverPays</code> åˆçº¦æ—¶ï¼Œ å…ˆè¿›è¡Œäº†ä¸€äº›æ”¯ä»˜ï¼Œç„¶åé”€æ¯è¯¥åˆçº¦ã€‚åæ¥ï¼Œ ä»–ä»¬å†³å®šå†æ¬¡éƒ¨ç½² <code>RecipientPays</code> åˆçº¦ï¼Œ ä½†æ–°çš„åˆçº¦ä¸çŸ¥é“ä»¥å‰åˆçº¦ä¸­ä½¿ç”¨çš„noncesï¼Œæ‰€ä»¥æ”»å‡»è€…å¯ä»¥å†æ¬¡ä½¿ç”¨æ—§çš„ä¿¡æ¯ã€‚</p>
<h4 id="ç»„è£…å‚æ•°"><a href="#ç»„è£…å‚æ•°" class="headerlink" title="ç»„è£…å‚æ•°"></a>ç»„è£…å‚æ•°</h4><p>æ—¢ç„¶æˆ‘ä»¬å·²ç»ç¡®å®šäº†è¦åœ¨ç­¾åä¿¡æ¯ä¸­åŒ…å«å“ªäº›ä¿¡æ¯ï¼Œ æˆ‘ä»¬å‡†å¤‡æŠŠä¿¡æ¯æ”¾åœ¨ä¸€èµ·ï¼Œè¿›è¡Œå“ˆå¸Œè¿ç®—ï¼Œç„¶åç­¾åã€‚ ç®€å•èµ·è§ï¼Œæˆ‘ä»¬æŠŠæ•°æ®è¿æ¥èµ·æ¥ã€‚ <a target="_blank" rel="noopener" href="https://github.com/ethereumjs/ethereumjs-abi">ethereumjs-abi</a> åº“æä¾›äº†ä¸€ä¸ªåä¸º <code>soliditySHA3</code> çš„å‡½æ•°ï¼Œ æ¨¡ä»¿Solidityçš„ <code>keccak256</code> å‡½æ•°åº”ç”¨äºä½¿ç”¨ <code>abi.encodePacked</code> ç¼–ç çš„å‚æ•°çš„è¡Œä¸ºã€‚ è¿™é‡Œæœ‰ä¸€ä¸ªJavaScriptå‡½æ•°ï¼Œä¸º <code>ReceiverPays</code> çš„ä¾‹å­åˆ›å»ºäº†é€‚å½“çš„ç­¾åã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">// recipientï¼Œ æ˜¯åº”è¯¥è¢«æ”¯ä»˜çš„åœ°å€ã€‚</span><br><span class="line">// amountï¼Œå•ä½æ˜¯ wei, æŒ‡å®šåº”è¯¥å‘é€å¤šå°‘etherã€‚</span><br><span class="line">// nonceï¼Œ å¯ä»¥æ˜¯ä»»ä½•å”¯ä¸€çš„æ•°å­—ï¼Œä»¥é˜²æ­¢é‡æ”¾æ”»å‡»ã€‚</span><br><span class="line">// contractAddressï¼Œ ç”¨äºé˜²æ­¢è·¨åˆçº¦çš„é‡æ”¾æ”»å‡»ã€‚</span><br><span class="line">function signPayment(recipient, amount, nonce, contractAddress, callback) &#123;</span><br><span class="line">    var hash = &quot;0x&quot; + abi.soliditySHA3(</span><br><span class="line">        [&quot;address&quot;, &quot;uint256&quot;, &quot;uint256&quot;, &quot;address&quot;],</span><br><span class="line">        [recipient, amount, nonce, contractAddress]</span><br><span class="line">    ).toString(&quot;hex&quot;);</span><br><span class="line"></span><br><span class="line">    web3.eth.personal.sign(hash, web3.eth.defaultAccount, callback);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>function signPayment(recipient, amount, nonce, contractAddress, callback) &#123;</code><br> å®šä¹‰ä¸€ä¸ªç”¨äºç”Ÿæˆå¹¶ç­¾åâ€œæ”¯ä»˜å‡­è¯â€çš„å‡½æ•°ï¼Œæœ€åé€šè¿‡ <code>callback</code> è¿”å›ç­¾åï¼ˆæˆ–é”™è¯¯ï¼‰ã€‚</p>
<p><code>var hash = &quot;0x&quot; + abi.soliditySHA3( ... ).toString(&quot;hex&quot;);</code><br> è¿™è¡Œæ˜¯å…³é”®ï¼Œåˆ†è§£å¦‚ä¸‹ï¼š</p>
<ul>
<li><code>abi.soliditySHA3([...types...], [...values...])</code>ï¼š<br> ä½œç”¨æ˜¯æŒ‰ <strong>Solidity çš„ <code>abi.encodePacked</code> ç¼–ç è§„åˆ™</strong> å°†å€¼æ‰“åŒ…ï¼Œç„¶åå¯¹æ‰“åŒ…åçš„å­—èŠ‚ä¸²åš keccak256ï¼ˆsolidity ä¸­çš„ <code>keccak256(abi.encodePacked(...))</code>ï¼‰ã€‚å®ƒæ¨¡ä»¿ Solidity ä¸­çš„è¡Œä¸ºï¼Œç¡®ä¿ JS ç«¯ç”Ÿæˆçš„å“ˆå¸Œä¸ Solidity åˆçº¦å†…é¢„æœŸä¸€è‡´ã€‚</li>
<li><code>.toString(&quot;hex&quot;)</code>ï¼šæŠŠ <code>abi.soliditySHA3</code> è¿”å›çš„ Buffer æˆ–äºŒè¿›åˆ¶ç»“æœè½¬ä¸º hex å­—ç¬¦ä¸²ï¼ˆä¸å¸¦ <code>0x</code> å‰ç¼€ï¼‰ã€‚<code>&quot;0x&quot; + ...</code>ï¼šåœ¨ä»¥å¤ªåŠç”Ÿæ€ä¸­ï¼Œåå…­è¿›åˆ¶å­—ç¬¦ä¸²é€šå¸¸å¸¦ <code>0x</code> å‰ç¼€ï¼Œæ‰€ä»¥è¿™é‡ŒåŠ ä¸Š <code>0x</code>ï¼Œå½¢æˆæ ‡å‡†çš„ hex hash å­—ç¬¦ä¸²ï¼ˆä¾‹å¦‚ <code>0xabc123...</code>ï¼‰ã€‚</li>
<li><code>personal.sign</code> ä¼š<strong>åœ¨ç­¾åå‰å†æ¬¡åŠ ä¸Š Ethereum æ¶ˆæ¯å‰ç¼€</strong>ï¼ˆ<code>\x19Ethereum Signed Message:\n$&#123;length&#125;</code>ï¼‰å¹¶å°† <code>length</code> è®¾ç½®ä¸ºä½ ä¼ å…¥ <code>hash</code> çš„é•¿åº¦ï¼ˆå¦‚æœä½ ä¼ å…¥çš„æ˜¯ 32 å­—èŠ‚ hashï¼Œè¿™ä¸ª length æ˜¯ 32ï¼Œç­¾åçš„æ˜¯å‰ç¼€+32å­—èŠ‚å†…å®¹ï¼‰ã€‚å› æ­¤ï¼Œç­¾åè€…å®é™…ç­¾çš„æ˜¯ <code>prefixed(hash)</code>ï¼Œä¸æ˜¯â€œè£¸å“ˆå¸Œâ€ã€‚è¿™å¯¼è‡´åœ¨åˆçº¦é‡Œç›´æ¥ç”¨ <code>ecrecover</code> å»éªŒè¯ <code>keccak256(abi.encodePacked(...))</code> çš„åŸå§‹å“ˆå¸Œ <strong>ä¸ä¼š</strong>ä¸ <code>personal.sign</code> çš„ç­¾åç›´æ¥å¯¹åº”ï¼Œé™¤éä½ åœ¨åˆçº¦é‡Œä¹ŸåšåŒæ ·çš„å‰ç¼€å¤„ç†ï¼ˆå³ç”¨ <code>keccak256(&quot;\x19Ethereum Signed Message:\n32&quot; + hash)</code>ï¼‰æ¥é‡å»ºç­¾åæ—¶çš„æ¶ˆæ¯æ‘˜è¦ã€‚æˆ–è€…ï¼Œä½ å¯ä»¥ç”¨å®¢æˆ·ç«¯ç­¾ <code>signTypedData</code>ï¼ˆEIP-712ï¼‰æ¥è·å¾—å¯è¢«åˆçº¦æ›´æ–¹ä¾¿æ ¡éªŒçš„ç»“æ„åŒ–ç­¾åã€‚</li>
<li>callback å‚æ•°é€šå¸¸æ˜¯ <code>(err, signature) =&gt; &#123; ... &#125;</code>ï¼Œç­¾åå­—ç¬¦ä¸²æ ¼å¼é€šå¸¸æ˜¯ 65 å­—èŠ‚å¹¶ç¼–ç ä¸º hexï¼ˆ<code>r</code> + <code>s</code> + <code>v</code>ï¼‰ã€‚</li>
</ul>
</blockquote>
<h4 id="åœ¨Solidityä¸­æ¢å¤ä¿¡æ¯ç­¾åè€…"><a href="#åœ¨Solidityä¸­æ¢å¤ä¿¡æ¯ç­¾åè€…" class="headerlink" title="åœ¨Solidityä¸­æ¢å¤ä¿¡æ¯ç­¾åè€…"></a>åœ¨Solidityä¸­æ¢å¤ä¿¡æ¯ç­¾åè€…</h4><p>web3.js äº§ç”Ÿçš„ç­¾åæ˜¯ <code>r</code>, <code>s</code> å’Œ <code>v</code> çš„æ‹¼æ¥çš„ï¼Œ æ‰€ä»¥ç¬¬ä¸€æ­¥æ˜¯æŠŠè¿™äº›å‚æ•°åˆ†å¼€ã€‚æ‚¨å¯ä»¥åœ¨å®¢æˆ·ç«¯è¿™æ ·åšï¼Œ ä½†åœ¨æ™ºèƒ½åˆçº¦å†…è¿™æ ·åšæ„å‘³ç€ä½ åªéœ€è¦å‘é€ä¸€ä¸ªç­¾åå‚æ•°è€Œä¸æ˜¯ä¸‰ä¸ªã€‚ å°†ä¸€ä¸ªå­—èŠ‚æ•°ç»„åˆ†å‰²æˆå®ƒçš„ç»„æˆéƒ¨åˆ†æ˜¯å¾ˆéº»çƒ¦çš„ï¼Œ æ‰€ä»¥æˆ‘ä»¬åœ¨ <code>splitSignature</code> å‡½æ•°ä¸­ä½¿ç”¨ <a target="_blank" rel="noopener" href="https://docs.soliditylang.org/zh-cn/v0.8.23/assembly.html">inline assembly</a> å®Œæˆè¿™é¡¹å·¥ä½œï¼ˆæœ¬èŠ‚æœ«å°¾çš„å®Œæ•´åˆçº¦ä¸­çš„ç¬¬ä¸‰ä¸ªå‡½æ•°ï¼‰ã€‚</p>
<h4 id="ä»£ç "><a href="#ä»£ç " class="headerlink" title="ä»£ç "></a>ä»£ç </h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: GPL-3.0</span><br><span class="line">pragma solidity &gt;=0.7.0 &lt;0.9.0;</span><br><span class="line">// è¿™å°†æŠ¥å‘Šä¸€ä¸ªç”±äºåºŸå¼ƒçš„ selfdestruct è€Œäº§ç”Ÿçš„è­¦å‘Š</span><br><span class="line">contract ReceiverPays &#123;</span><br><span class="line">    address owner = msg.sender;</span><br><span class="line"></span><br><span class="line">    mapping(uint256 =&gt; bool) usedNonces;</span><br><span class="line"></span><br><span class="line">    constructor() payable &#123;&#125;</span><br><span class="line"></span><br><span class="line">    function claimPayment(uint256 amount, uint256 nonce, bytes memory signature) external &#123;</span><br><span class="line">        require(!usedNonces[nonce]);</span><br><span class="line">        usedNonces[nonce] = true;</span><br><span class="line"></span><br><span class="line">        // è¿™å°†é‡æ–°åˆ›å»ºåœ¨å®¢æˆ·ç«¯ä¸Šç­¾åçš„ä¿¡æ¯ã€‚</span><br><span class="line">        bytes32 message = prefixed(keccak256(abi.encodePacked(msg.sender, amount, nonce, this)));</span><br><span class="line"></span><br><span class="line">        require(recoverSigner(message, signature) == owner);</span><br><span class="line"></span><br><span class="line">        payable(msg.sender).transfer(amount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /// é”€æ¯åˆçº¦å¹¶æ”¶å›å‰©ä½™çš„èµ„é‡‘ã€‚</span><br><span class="line">    function shutdown() external &#123;</span><br><span class="line">        require(msg.sender == owner);</span><br><span class="line">        selfdestruct(payable(msg.sender));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /// ç­¾åæ–¹æ³•ã€‚</span><br><span class="line">    function splitSignature(bytes memory sig)</span><br><span class="line">        internal</span><br><span class="line">        pure</span><br><span class="line">        returns (uint8 v, bytes32 r, bytes32 s)</span><br><span class="line">    &#123;</span><br><span class="line">        require(sig.length == 65);</span><br><span class="line"></span><br><span class="line">        assembly &#123;</span><br><span class="line">            // å‰32ä¸ªå­—èŠ‚ï¼Œåœ¨é•¿åº¦å‰ç¼€ä¹‹åã€‚</span><br><span class="line">            r := mload(add(sig, 32))</span><br><span class="line">            // ç¬¬äºŒä¸ª32å­—èŠ‚ã€‚</span><br><span class="line">            s := mload(add(sig, 64))</span><br><span class="line">            // æœ€åä¸€ä¸ªå­—èŠ‚ï¼ˆä¸‹ä¸€ä¸ª32å­—èŠ‚çš„ç¬¬ä¸€ä¸ªå­—èŠ‚ï¼‰ã€‚</span><br><span class="line">            v := byte(0, mload(add(sig, 96)))</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return (v, r, s);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function recoverSigner(bytes32 message, bytes memory sig)</span><br><span class="line">        internal</span><br><span class="line">        pure</span><br><span class="line">        returns (address)</span><br><span class="line">    &#123;</span><br><span class="line">        (uint8 v, bytes32 r, bytes32 s) = splitSignature(sig);</span><br><span class="line"></span><br><span class="line">        return ecrecover(message, v, r, s);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /// æ„å»ºä¸€ä¸ªå‰ç¼€å“ˆå¸Œå€¼ï¼Œä»¥æ¨¡ä»¿ eth_sign çš„è¡Œä¸ºã€‚</span><br><span class="line">    function prefixed(bytes32 hash) internal pure returns (bytes32) &#123;</span><br><span class="line">        return keccak256(abi.encodePacked(&quot;\x19Ethereum Signed Message:\n32&quot;, hash));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/solidity/" rel="tag"># solidity</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2025/10/03/%E5%8C%BA%E5%9D%97%E9%93%BE/%E6%92%B8%E6%AF%9B/" rel="prev" title="æ’¸æ¯›">
                  <i class="fa fa-chevron-left"></i> æ’¸æ¯›
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2025/10/08/%E5%8C%BA%E5%9D%97%E9%93%BE/%E4%B8%89%E6%98%8E%E6%B2%BB%E6%94%BB%E5%87%BBSanwich%20Attack%E5%92%8CMEV/" rel="next" title="ä¸‰æ˜æ²»æ”»å‡»Sanwich Attackå’ŒMEV">
                  ä¸‰æ˜æ²»æ”»å‡»Sanwich Attackå’ŒMEV <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">é™ˆå®‡éŸ¶chenyushao</span>
</div>
  <div class="powered-by">ç”± <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a> å¼ºåŠ›é©±åŠ¨
  </div>

    </div>
  </footer>

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  





  





</body>
</html>
